name: Update PPA Packages

on:
  workflow_dispatch:
    inputs:
      package:
        description: "Package to upload (dms, dms-git, dms-greeter, or all)"
        required: false
        default: "dms-git"
      rebuild_release:
        description: "Release number for rebuilds (e.g., 2, 3, 4 for ppa2, ppa3, ppa4)"
        required: false
        default: ""
  schedule:
    - cron: "0 */3 * * *" # Every 3 hours for dms-git builds

jobs:
  check-updates:
    name: Check for updates
    runs-on: ubuntu-latest

    outputs:
      has_updates: ${{ steps.check.outputs.has_updates }}
      packages: ${{ steps.check.outputs.packages }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for updates
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "packages=dms-git" >> $GITHUB_OUTPUT
            echo "Checking if dms-git source has changed..."

            # Get current commit hash (8 chars to match changelog format)
            CURRENT_COMMIT=$(git rev-parse --short=8 HEAD)

            # Extract commit hash from changelog
            # Format: dms-git (0.6.2+git2264.c5c5ce84) questing; urgency=medium
            CHANGELOG_FILE="distro/ubuntu/dms-git/debian/changelog"

            if [[ -f "$CHANGELOG_FILE" ]]; then
              CHANGELOG_COMMIT=$(head -1 "$CHANGELOG_FILE" | grep -oP '\.[a-f0-9]{8}' | tr -d '.' || echo "")

              if [[ -n "$CHANGELOG_COMMIT" ]]; then
                if [[ "$CURRENT_COMMIT" == "$CHANGELOG_COMMIT" ]]; then
                  echo "has_updates=false" >> $GITHUB_OUTPUT
                  echo "ðŸ“‹ Commit $CURRENT_COMMIT already in changelog, skipping upload"
                else
                  echo "has_updates=true" >> $GITHUB_OUTPUT
                  echo "ðŸ“‹ New commit detected: $CURRENT_COMMIT (changelog has $CHANGELOG_COMMIT)"
                fi
              else
                echo "has_updates=true" >> $GITHUB_OUTPUT
                echo "ðŸ“‹ Could not extract commit from changelog, proceeding with upload"
              fi
            else
              echo "has_updates=true" >> $GITHUB_OUTPUT
              echo "ðŸ“‹ No changelog file found, proceeding with upload"
            fi
          elif [[ -n "${{ github.event.inputs.package }}" ]]; then
            echo "packages=${{ github.event.inputs.package }}" >> $GITHUB_OUTPUT
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "Manual trigger: ${{ github.event.inputs.package }}"
          else
            echo "packages=dms-git" >> $GITHUB_OUTPUT
            echo "has_updates=true" >> $GITHUB_OUTPUT
          fi

  upload-ppa:
    name: Upload to PPA
    needs: check-updates
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    if: |
      github.event_name == 'workflow_dispatch' ||
      needs.check-updates.outputs.has_updates == 'true'

    steps:
      - name: Generate GitHub App Token
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.generate_token.outputs.token }}

      - name: Check if last commit was automated
        id: check-loop
        run: |
          LAST_COMMIT_MSG=$(git log -1 --pretty=%B | head -1)
          if [[ "$LAST_COMMIT_MSG" == "ci: Auto-update PPA packages"* ]] || [[ "$LAST_COMMIT_MSG" == "ci: Auto-update OBS packages"* ]]; then
            echo "â­ï¸ Last commit was automated ($LAST_COMMIT_MSG), skipping to prevent infinite loop"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Last commit was not automated, proceeding"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Go
        if: steps.check-loop.outputs.skip != 'true'
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache: false

      - name: Install build dependencies
        if: steps.check-loop.outputs.skip != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            debhelper \
            devscripts \
            dput \
            lftp \
            build-essential \
            fakeroot \
            dpkg-dev

      - name: Configure GPG
        if: steps.check-loop.outputs.skip != 'true'
        env:
          GPG_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          echo "$GPG_KEY" | gpg --import
          GPG_KEY_ID=$(gpg --list-secret-keys --keyid-format LONG | grep sec | awk '{print $2}' | cut -d'/' -f2)
          echo "DEBSIGN_KEYID=$GPG_KEY_ID" >> $GITHUB_ENV

      - name: Determine packages to upload
        if: steps.check-loop.outputs.skip != 'true'
        id: packages
        run: |
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "packages=${{ needs.check-updates.outputs.packages }}" >> $GITHUB_OUTPUT
            echo "Triggered by schedule: uploading git package"
          elif [[ -n "${{ github.event.inputs.package }}" ]]; then
            echo "packages=${{ github.event.inputs.package }}" >> $GITHUB_OUTPUT
            echo "Manual trigger: ${{ github.event.inputs.package }}"
          else
            echo "packages=${{ needs.check-updates.outputs.packages }}" >> $GITHUB_OUTPUT
          fi

      - name: Upload to PPA
        if: steps.check-loop.outputs.skip != 'true'
        run: |
          PACKAGES="${{ steps.packages.outputs.packages }}"
          REBUILD_RELEASE="${{ github.event.inputs.rebuild_release }}"

          # Build command arguments
          BUILD_ARGS=()
          if [[ -n "$REBUILD_RELEASE" ]]; then
            BUILD_ARGS+=("$REBUILD_RELEASE")
            echo "âœ“ Using rebuild release number: ppa$REBUILD_RELEASE"
          fi

          if [[ "$PACKAGES" == "all" ]]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Uploading dms to PPA..."
            if [ -n "$REBUILD_RELEASE" ]; then
              echo "ðŸ”„ Using rebuild release number: ppa$REBUILD_RELEASE"
            fi
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            bash distro/scripts/ppa-upload.sh dms dms questing "${BUILD_ARGS[@]}"

            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Uploading dms-git to PPA..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            bash distro/scripts/ppa-upload.sh dms-git dms-git questing "${BUILD_ARGS[@]}"

            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Uploading dms-greeter to PPA..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            bash distro/scripts/ppa-upload.sh dms-greeter danklinux questing "${BUILD_ARGS[@]}"
          else
            # Map package to PPA name
            case "$PACKAGES" in
              dms)
                PPA_NAME="dms"
                ;;
              dms-git)
                PPA_NAME="dms-git"
                ;;
              dms-greeter)
                PPA_NAME="danklinux"
                ;;
              *)
                PPA_NAME="$PACKAGES"
                ;;
            esac

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Uploading $PACKAGES to PPA..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            bash distro/scripts/ppa-upload.sh "$PACKAGES" "$PPA_NAME" questing "${BUILD_ARGS[@]}"
          fi

      - name: Get changed packages
        if: steps.check-loop.outputs.skip != 'true'
        id: changed-packages
        run: |
          # Check if there are any changelog changes to commit
          if git diff --exit-code distro/ubuntu/ >/dev/null 2>&1; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ No changelog changes to commit"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            # Get list of changed packages for commit message (deduplicate)
            CHANGED=$(git diff --name-only distro/ubuntu/ | grep 'debian/changelog' | sed 's|/debian/changelog||' | xargs -I{} basename {} | sort -u | tr '\n' ',' | sed 's/,$//')
            echo "packages=$CHANGED" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ Changed packages: $CHANGED"
            echo "ðŸ“‹ Debug - Changed files:"
            git diff --name-only distro/ubuntu/ | grep 'debian/changelog' || echo "No changelog files found"
          fi

      - name: Commit changelog changes
        if: steps.check-loop.outputs.skip != 'true' && steps.changed-packages.outputs.has_changes == 'true'
        run: |
          git config user.name "dms-ci[bot]"
          git config user.email "dms-ci[bot]@users.noreply.github.com"
          git add distro/ubuntu/*/debian/changelog
          git commit -m "ci: Auto-update PPA packages [${{ steps.changed-packages.outputs.packages }}]" -m "ðŸ¤– Automated by GitHub Actions"
          git pull --rebase origin master
          git push

      - name: Summary
        run: |
          echo "### PPA Package Upload Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Packages**: ${{ steps.packages.outputs.packages }}" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.check-updates.outputs.has_updates }}" == "false" ]]; then
            echo "- **Status**: Skipped (no changes detected)" >> $GITHUB_STEP_SUMMARY
          fi

          PACKAGES="${{ steps.packages.outputs.packages }}"
          if [[ "$PACKAGES" == "all" ]]; then
            echo "- **PPA dms**: https://launchpad.net/~avengemedia/+archive/ubuntu/dms/+packages" >> $GITHUB_STEP_SUMMARY
            echo "- **PPA dms-git**: https://launchpad.net/~avengemedia/+archive/ubuntu/dms-git/+packages" >> $GITHUB_STEP_SUMMARY
            echo "- **PPA danklinux**: https://launchpad.net/~avengemedia/+archive/ubuntu/danklinux/+packages" >> $GITHUB_STEP_SUMMARY
          elif [[ "$PACKAGES" == "dms" ]]; then
            echo "- **PPA**: https://launchpad.net/~avengemedia/+archive/ubuntu/dms/+packages" >> $GITHUB_STEP_SUMMARY
          elif [[ "$PACKAGES" == "dms-git" ]]; then
            echo "- **PPA**: https://launchpad.net/~avengemedia/+archive/ubuntu/dms-git/+packages" >> $GITHUB_STEP_SUMMARY
          elif [[ "$PACKAGES" == "dms-greeter" ]]; then
            echo "- **PPA**: https://launchpad.net/~avengemedia/+archive/ubuntu/danklinux/+packages" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ -n "${{ steps.packages.outputs.version }}" ]]; then
            echo "- **Version**: ${{ steps.packages.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Builds will appear once Launchpad processes the uploads." >> $GITHUB_STEP_SUMMARY
